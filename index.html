<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Pocket Drill Coach ‚Äî Metronome ¬∑ Intervals ¬∑ Prompts</title>
<style>
  :root{--bg:#0b0b0f;--card:#12151b;--fg:#f1f3f5;--muted:#9aa0a6;--acc:#5ec6ff;--ok:#06d6a0;--warn:#ffd166}
  *{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto}
  header{padding:14px 16px;border-bottom:1px solid #1f2229;display:flex;gap:12px;align-items:center;position:sticky;top:0;background:#0b0b0feb;backdrop-filter:blur(8px)}
  h1{font-size:16px;margin:0}main{max-width:960px;margin:0 auto;padding:16px;display:grid;gap:12px}
  .grid{display:grid;gap:12px}.g2{grid-template-columns:repeat(2,minmax(0,1fr))}
  .card{background:var(--card);border:1px solid #1f2229;border-radius:14px;padding:12px}
  label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}
  input,select,button,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #242833;background:#0e1117;color:var(--fg);font-size:14px}
  button.primary{background:linear-gradient(180deg,#2b9eff,#0078ff);border:none}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .pill{padding:6px 10px;border:1px solid #242833;border-radius:999px;color:var(--muted);font-size:12px}
  .big{font-size:40px;font-weight:700;text-align:center}
  .center{display:flex;justify-content:center;align-items:center;gap:8px}
  .ok{color:var(--ok)} .warn{color:var(--warn)}
  textarea{min-height:120px;resize:vertical}
  .muted{color:var(--muted);font-size:12px}
</style>
</head>
<body>
<header>
  <h1>üéß Pocket Drill Coach</h1>
  <span class="pill">–±–µ–∑ –ø—Ä–∞–≤–∞ ¬∑ –æ—Ñ–ª–∞–π–Ω</span>
  <span class="pill" id="status">–≥–æ—Ç–æ–≤</span>
</header>

<main>
  <div class="grid g2">
    <div class="card">
      <div class="row">
        <div style="flex:1">
          <label for="bpm">BPM</label>
          <input id="bpm" type="number" min="30" max="220" value="96">
        </div>
        <div style="width:140px">
          <label for="meter">–ú–µ—Ç—Ä</label>
          <select id="meter">
            <option value="4">4/4</option>
            <option value="3">3/4</option>
            <option value="2">2/4</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnMetro" class="primary" style="flex:1">‚ñ∂Ô∏é –ü—É—Å–Ω–∏ –º–µ—Ç—Ä–æ–Ω–æ–º</button>
        <button id="btnTap" style="width:160px">Tap Tempo</button>
      </div>
      <div class="center" style="margin-top:8px">
        <div class="big" id="beat">‚Äî</div>
        <div class="pill" id="bpmLive">96 BPM</div>
      </div>
      <div class="muted">–ê–∫—Ü–µ–Ω—Ç –Ω–∞ 1. –ü–æ–¥—Ö–æ–¥—è—â –∑–∞ TopRock –∏ –≤—Ö–æ–¥–æ–≤–µ –∫—ä–º drops.</div>
    </div>

    <div class="card">
      <div class="row">
        <div style="flex:1">
          <label for="work">–†–∞–±–æ—Ç–∞ (—Å–µ–∫)</label>
          <input id="work" type="number" min="5" value="40">
        </div>
        <div style="flex:1">
          <label for="rest">–ü–æ—á–∏–≤–∫–∞ (—Å–µ–∫)</label>
          <input id="rest" type="number" min="5" value="20">
        </div>
        <div style="flex:1">
          <label for="rounds">–ö—Ä—ä–≥–æ–≤–µ</label>
          <input id="rounds" type="number" min="1" value="6">
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnIntervals" class="primary" style="flex:1">‚ñ∂Ô∏é –°—Ç–∞—Ä—Ç–∏—Ä–∞–π –∏–Ω—Ç–µ—Ä–≤–∞–ª–∏</button>
        <button id="btnReset">Reset</button>
      </div>
      <div class="center" style="margin-top:8px">
        <div class="big" id="intervalTime">00:00</div>
        <div class="pill" id="intervalState">–≥–æ—Ç–æ–≤</div>
        <div class="pill" id="intervalRound">0/0</div>
      </div>
      <div class="muted">–ö–æ–º–±–æ: –ø—É—Å–Ω–∏ –º–µ—Ç—Ä–æ–Ω–æ–º–∞ + –∏–Ω—Ç–µ—Ä–≤–∞–ª–∏ –∑–∞ ‚Äû–∫—Ä—ä–≥–æ–≤–µ —Å –º—É–∑–∏–∫–∞–ª–Ω–æ –≤—Ä–µ–º–µ‚Äú.</div>
    </div>
  </div>

  <div class="card">
    <label for="prompts">–ö–æ–º–∞–Ω–¥–∏ (–ø–æ –µ–¥–Ω–∞ –Ω–∞ —Ä–µ–¥)</label>
    <textarea id="prompts">TopRock
Indian Step
TopRock ‚Üí Knee Drop
TopRock ‚Üí Sweep Drop
TopRock ‚Üí Spin Drop
TopRock ‚Üí Hook Drop
TopRock ‚Üí Collapse Drop
TopRock ‚Üí Roll Drop
TopRock ‚Üí Suicide Drop
Six-Step ‚Üí Baby Freeze
Freeze (–∑–∞–¥—Ä—ä–∂ 2 —Ç–∞–∫—Ç–∞)
Footwork ‚Äì 3 —Å—Ç—ä–ø–∫–∏
Backstep ‚Üí CC
Uprock ‚Üí –≤—Ö–æ–¥</textarea>

    <div class="grid g2" style="margin-top:8px">
      <div>
        <label for="mode">–†–µ–∂–∏–º –Ω–∞ –ø–æ–¥–∞–≤–∞–Ω–µ</label>
        <select id="mode">
          <option value="beats">–Ω–∞ –≤—Å–µ–∫–∏ N —É–¥–∞—Ä–∞</option>
          <option value="seconds">–Ω–∞ –≤—Å–µ–∫–∏ N —Å–µ–∫—É–Ω–¥–∏</option>
        </select>
      </div>
      <div>
        <label for="everyN">–ò–Ω—Ç–µ—Ä–≤–∞–ª (N)</label>
        <input id="everyN" type="number" min="1" value="8">
      </div>
    </div>

    <div class="row" style="margin-top:8px">
      <button id="btnPrompts" class="primary" style="flex:1">‚ñ∂Ô∏é –ü—É—Å–Ω–∏ –∫–æ–º–∞–Ω–¥–∏</button>
      <button id="btnNext">–°–ª–µ–¥–≤–∞—â–∞</button>
    </div>
    <div class="center" style="margin-top:8px">
      <div class="big" id="prompt">‚Äî</div>
    </div>
    <div class="muted">–°—ä–≤–µ—Ç: —Å–ª–æ–∂–∏ N=8 —É–¥–∞—Ä–∞ (2 —Ç–∞–∫—Ç–∞ –Ω–∞ 4/4) –∑–∞ –ø–ª–∞–≤–Ω–∏ –≤—Ö–æ–¥–æ–≤–µ —Å –∏–Ω–µ—Ä—Ü–∏—è.</div>
  </div>

  <div class="card">
    <div class="row">
      <button id="btnAllStart" class="primary" style="flex:1">‚ñ∂Ô∏é –ü—É—Å–Ω–∏ –≤—Å–∏—á–∫–æ</button>
      <button id="btnAllStop" style="flex:1">‚ñ† –°–ø—Ä–∏ –≤—Å–∏—á–∫–æ</button>
    </div>
    <div class="muted" style="margin-top:8px">–ü—ä—Ä–≤–∏—è—Ç –∫–ª–∏–∫ –æ—Ç–∫–ª—é—á–≤–∞ –∑–≤—É–∫–∞ (–ø—Ä–∞–≤–∏–ª–æ –Ω–∞ –±—Ä–∞—É–∑—ä—Ä–∏—Ç–µ).</div>
  </div>
</main>

<script>
let ac, clickHi, clickLo, runningMetro=false, metroTimer=null, beat=0, beatsPerBar=4, lastTap=0, taps=[];
let runningIntervals=false, intervalTimer=null, phase='ready', leftInPhase=0, round=0, totalRounds=0;
let runningPrompts=false, promptsList=[], promptTimer=null, promptEvery=8, promptMode='beats', beatsSince=0;

const $=id=>document.getElementById(id);
function fmt(t){ t=Math.max(0,Math.floor(t)); const m=String(Math.floor(t/60)).padStart(2,'0'); const s=String(t%60).padStart(2,'0'); return m+':'+s; }

function ensureAudio(){
  if(ac) return;
  ac = new (window.AudioContext||window.webkitAudioContext)();
  // clicks
  clickHi = (when)=>{
    const o = ac.createOscillator(); const g = ac.createGain();
    o.type='square'; o.frequency.value=1760; g.gain.value=0.001;
    o.connect(g).connect(ac.destination);
    g.gain.setValueAtTime(0.001, when);
    g.gain.exponentialRampToValueAtTime(0.5, when+0.001);
    g.gain.exponentialRampToValueAtTime(0.001, when+0.06);
    o.start(when); o.stop(when+0.07);
  };
  clickLo = (when)=>{
    const o = ac.createOscillator(); const g = ac.createGain();
    o.type='square'; o.frequency.value=880; g.gain.value=0.001;
    o.connect(g).connect(ac.destination);
    g.gain.setValueAtTime(0.001, when);
    g.gain.exponentialRampToValueAtTime(0.4, when+0.001);
    g.gain.exponentialRampToValueAtTime(0.001, when+0.05);
    o.start(when); o.stop(when+0.06);
  };
}

function startMetronome(){
  ensureAudio(); if(ac.state==='suspended') ac.resume();
  runningMetro=true; beat=0; scheduleTick(); $('btnMetro').textContent='‚ñ† –°–ø—Ä–∏ –º–µ—Ç—Ä–æ–Ω–æ–º';
}
function stopMetronome(){
  runningMetro=false; clearTimeout(metroTimer); $('beat').textContent='‚Äî'; $('btnMetro').textContent='‚ñ∂Ô∏é –ü—É—Å–Ω–∏ –º–µ—Ç—Ä–æ–Ω–æ–º';
}
function scheduleTick(){
  if(!runningMetro) return;
  const bpm = Math.max(30, Math.min(220, Number($('bpm').value)||96));
  $('bpmLive').textContent = bpm+' BPM';
  beatsPerBar = Number($('meter').value)||4;

  const now = ac.currentTime;
  const isAccent = (beat % beatsPerBar)===0;
  (isAccent?clickHi:clickLo)(now+0.02);
  $('beat').textContent = (beat % beatsPerBar)+1;
  if(runningPrompts && promptMode==='beats'){
    beatsSince++;
    if(beatsSince>=promptEvery){ nextPrompt(); beatsSince=0; }
  }
  beat++;
  const intervalMs = 60000/bpm;
  metroTimer = setTimeout(scheduleTick, intervalMs);
}

$('btnMetro').onclick=()=>{
  if(!runningMetro) startMetronome(); else stopMetronome();
};

$('btnTap').onclick=()=>{
  const t = performance.now();
  if(t-lastTap>2000) taps.length=0;
  if(lastTap) taps.push(t-lastTap);
  lastTap=t;
  if(taps.length>=3){
    const avg = taps.slice(-6).reduce((a,b)=>a+b,0)/Math.min(6,taps.length);
    const bpm = Math.round(60000/avg);
    $('bpm').value = bpm; $('bpmLive').textContent=bpm+' BPM';
  }
};

// Intervals
function startIntervals(){
  ensureAudio(); if(ac.state==='suspended') ac.resume();
  if(runningIntervals) return;
  const w = Math.max(5, Number($('work').value)||40);
  const r = Math.max(5, Number($('rest').value)||20);
  totalRounds = Math.max(1, Number($('rounds').value)||6);
  round = 0;
  runningIntervals=true; phase='work'; leftInPhase=w; $('intervalState').textContent='—Ä–∞–±–æ—Ç–∞'; $('intervalState').className='pill ok'; nextIntervalTick();
  $('btnIntervals').textContent='‚ñ† –°–ø—Ä–∏ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∏';
}
function stopIntervals(){
  runningIntervals=false; clearTimeout(intervalTimer); $('intervalState').textContent='–≥–æ—Ç–æ–≤'; $('intervalTime').textContent='00:00'; $('intervalRound').textContent='0/'+totalRounds; $('btnIntervals').textContent='‚ñ∂Ô∏é –°—Ç–∞—Ä—Ç–∏—Ä–∞–π –∏–Ω—Ç–µ—Ä–≤–∞–ª–∏';
}
function nextIntervalTick(){
  if(!runningIntervals) return;
  $('intervalTime').textContent=fmt(leftInPhase);
  $('intervalRound').textContent=round+'/'+totalRounds;
  if(leftInPhase<=0){
    // switch
    if(phase==='work'){
      round++; if(round>totalRounds){ stopIntervals(); return; }
      phase='rest'; leftInPhase=Math.max(5, Number($('rest').value)||20);
      $('intervalState').textContent='–ø–æ—á–∏–≤–∫–∞'; $('intervalState').className='pill warn';
      cue('–ü–æ—á–∏–≤–∫–∞ ‚Äì –¥–∏—à–∞–π.');
    }else{
      phase='work'; leftInPhase=Math.max(5, Number($('work').value)||40);
      $('intervalState').textContent='—Ä–∞–±–æ—Ç–∞'; $('intervalState').className='pill ok';
      cue('–†–∞–±–æ—Ç–∞ ‚Äì –≤–ª–µ–∑ —Å –∏–Ω–µ—Ä—Ü–∏—è!');
    }
  }
  leftInPhase--;
  intervalTimer=setTimeout(nextIntervalTick,1000);
}

// Prompts
function parsePrompts(){
  promptsList = $('prompts').value.split('\n').map(s=>s.trim()).filter(Boolean);
  if(promptsList.length===0) promptsList=['TopRock','Knee Drop','Sweep Drop'];
}
function nextPrompt(){
  if(promptsList.length===0) parsePrompts();
  const i = Math.floor(Math.random()*promptsList.length);
  const p = promptsList[i];
  $('prompt').textContent = p;
  speak(p);
}
function startPrompts(){
  parsePrompts();
  promptMode = $('mode').value;
  promptEvery = Math.max(1, Number($('everyN').value)||8);
  runningPrompts=true; beatsSince=0;
  $('btnPrompts').textContent='‚ñ† –°–ø—Ä–∏ –∫–æ–º–∞–Ω–¥–∏';
  if(promptMode==='seconds'){
    promptTimer = setInterval(nextPrompt, promptEvery*1000);
  }else{
    // on beats: will fire from metronome scheduler
    if(!runningMetro) startMetronome();
  }
  nextPrompt();
}
function stopPrompts(){
  runningPrompts=false; clearInterval(promptTimer); $('btnPrompts').textContent='‚ñ∂Ô∏é –ü—É—Å–Ω–∏ –∫–æ–º–∞–Ω–¥–∏'; $('prompt').textContent='‚Äî';
}

function cue(text){
  $('status').textContent=text;
  try{
    const u=new SpeechSynthesisUtterance(text); u.lang='bg-BG'; u.rate=1.05; speechSynthesis.cancel(); speechSynthesis.speak(u);
  }catch(e){}
}

// All-in-one
$('btnIntervals').onclick=()=> runningIntervals?stopIntervals():startIntervals();
$('btnPrompts').onclick=()=> runningPrompts?stopPrompts():startPrompts();
$('btnNext').onclick=()=> nextPrompt();
$('btnAllStart').onclick=()=>{ if(!runningMetro) startMetronome(); if(!runningIntervals) startIntervals(); if(!runningPrompts) startPrompts(); };
$('btnAllStop').onclick=()=>{ stopPrompts(); stopIntervals(); stopMetronome(); };

// defaults
$('intervalRound').textContent='0/'+($('rounds').value||6);
</script>
</body>
</html>
