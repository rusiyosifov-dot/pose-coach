<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
  <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
  <meta http-equiv="Content-Style-Type" content="text/css">
  <title></title>
  <meta name="Generator" content="Cocoa HTML Writer">
  <meta name="CocoaVersion" content="1561.61">
  <style type="text/css">
    p.p1 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 14.0px; font: 12.0px Helvetica; color: #000000; -webkit-text-stroke: #000000}
    p.p2 {margin: 0.0px 0.0px 0.0px 0.0px; line-height: 14.0px; font: 12.0px Helvetica; color: #000000; -webkit-text-stroke: #000000; min-height: 14.0px}
    span.s1 {font-kerning: none}
    span.s2 {font: 12.0px 'Apple Color Emoji'; font-kerning: none}
    span.s3 {font: 12.0px 'Lucida Grande'; font-kerning: none}
  </style>
</head>
<body>
<p class="p1"><span class="s1">&lt;!DOCTYPE html&gt;</span></p>
<p class="p1"><span class="s1">&lt;html lang="bg"&gt;</span></p>
<p class="p1"><span class="s1">&lt;head&gt;</span></p>
<p class="p1"><span class="s1">&lt;meta charset="utf-8"&gt;</span></p>
<p class="p1"><span class="s1">&lt;meta name="viewport" content="width=device-width,initial-scale=1"&gt;</span></p>
<p class="p1"><span class="s1">&lt;title&gt;Pocket Drill Coach — Metronome · Intervals · Prompts&lt;/title&gt;</span></p>
<p class="p1"><span class="s1">&lt;style&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>:root{--bg:#0b0b0f;--card:#12151b;--fg:#f1f3f5;--muted:#9aa0a6;--acc:#5ec6ff;--ok:#06d6a0;--warn:#ffd166}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>*{box-sizing:border-box}body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>header{padding:14px 16px;border-bottom:1px solid #1f2229;display:flex;gap:12px;align-items:center;position:sticky;top:0;background:#0b0b0feb;backdrop-filter:blur(8px)}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>h1{font-size:16px;margin:0}main{max-width:960px;margin:0 auto;padding:16px;display:grid;gap:12px}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>.grid{display:grid;gap:12px}.g2{grid-template-columns:repeat(2,minmax(0,1fr))}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>.card{background:var(--card);border:1px solid #1f2229;border-radius:14px;padding:12px}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>label{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>input,select,button,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #242833;background:#0e1117;color:var(--fg);font-size:14px}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>button.primary{background:linear-gradient(180deg,#2b9eff,#0078ff);border:none}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>.row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>.pill{padding:6px 10px;border:1px solid #242833;border-radius:999px;color:var(--muted);font-size:12px}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>.big{font-size:40px;font-weight:700;text-align:center}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>.center{display:flex;justify-content:center;align-items:center;gap:8px}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>.ok{color:var(--ok)} .warn{color:var(--warn)}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>textarea{min-height:120px;resize:vertical}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>.muted{color:var(--muted);font-size:12px}</span></p>
<p class="p1"><span class="s1">&lt;/style&gt;</span></p>
<p class="p1"><span class="s1">&lt;/head&gt;</span></p>
<p class="p1"><span class="s1">&lt;body&gt;</span></p>
<p class="p1"><span class="s1">&lt;header&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;h1&gt;</span><span class="s2">🎧</span><span class="s1"> Pocket Drill Coach&lt;/h1&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;span class="pill"&gt;без права · офлайн&lt;/span&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;span class="pill" id="status"&gt;готов&lt;/span&gt;</span></p>
<p class="p1"><span class="s1">&lt;/header&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">&lt;main&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;div class="grid g2"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;div class="card"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;div class="row"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div style="flex:1"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>&lt;label for="bpm"&gt;BPM&lt;/label&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>&lt;input id="bpm" type="number" min="30" max="220" value="96"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div style="width:140px"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>&lt;label for="meter"&gt;Метр&lt;/label&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>&lt;select id="meter"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;option value="4"&gt;4/4&lt;/option&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;option value="3"&gt;3/4&lt;/option&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">            </span>&lt;option value="2"&gt;2/4&lt;/option&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>&lt;/select&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;div class="row" style="margin-top:8px"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;button id="btnMetro" class="primary" style="flex:1"&gt;</span><span class="s3">▶︎</span><span class="s1"> Пусни метроном&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;button id="btnTap" style="width:160px"&gt;Tap Tempo&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;div class="center" style="margin-top:8px"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div class="big" id="beat"&gt;—&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div class="pill" id="bpmLive"&gt;96 BPM&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;div class="muted"&gt;Акцент на 1. Подходящ за TopRock и входове към drops.&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;div class="card"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;div class="row"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div style="flex:1"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>&lt;label for="work"&gt;Работа (сек)&lt;/label&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>&lt;input id="work" type="number" min="5" value="40"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div style="flex:1"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>&lt;label for="rest"&gt;Почивка (сек)&lt;/label&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>&lt;input id="rest" type="number" min="5" value="20"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div style="flex:1"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>&lt;label for="rounds"&gt;Кръгове&lt;/label&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>&lt;input id="rounds" type="number" min="1" value="6"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;div class="row" style="margin-top:8px"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;button id="btnIntervals" class="primary" style="flex:1"&gt;</span><span class="s3">▶︎</span><span class="s1"> Стартирай интервали&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;button id="btnReset"&gt;Reset&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;div class="center" style="margin-top:8px"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div class="big" id="intervalTime"&gt;00:00&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div class="pill" id="intervalState"&gt;готов&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;div class="pill" id="intervalRound"&gt;0/0&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;div class="muted"&gt;Комбо: пусни метронома + интервали за „кръгове с музикално време“.&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;div class="card"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;label for="prompts"&gt;Команди (по една на ред)&lt;/label&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;textarea id="prompts"&gt;TopRock</span></p>
<p class="p1"><span class="s1">Indian Step</span></p>
<p class="p1"><span class="s1">TopRock </span><span class="s3">→</span><span class="s1"> Knee Drop</span></p>
<p class="p1"><span class="s1">TopRock </span><span class="s3">→</span><span class="s1"> Sweep Drop</span></p>
<p class="p1"><span class="s1">TopRock </span><span class="s3">→</span><span class="s1"> Spin Drop</span></p>
<p class="p1"><span class="s1">TopRock </span><span class="s3">→</span><span class="s1"> Hook Drop</span></p>
<p class="p1"><span class="s1">TopRock </span><span class="s3">→</span><span class="s1"> Collapse Drop</span></p>
<p class="p1"><span class="s1">TopRock </span><span class="s3">→</span><span class="s1"> Roll Drop</span></p>
<p class="p1"><span class="s1">TopRock </span><span class="s3">→</span><span class="s1"> Suicide Drop</span></p>
<p class="p1"><span class="s1">Six-Step </span><span class="s3">→</span><span class="s1"> Baby Freeze</span></p>
<p class="p1"><span class="s1">Freeze (задръж 2 такта)</span></p>
<p class="p1"><span class="s1">Footwork – 3 стъпки</span></p>
<p class="p1"><span class="s1">Backstep </span><span class="s3">→</span><span class="s1"> CC</span></p>
<p class="p1"><span class="s1">Uprock </span><span class="s3">→</span><span class="s1"> вход&lt;/textarea&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;div class="grid g2" style="margin-top:8px"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;label for="mode"&gt;Режим на подаване&lt;/label&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;select id="mode"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>&lt;option value="beats"&gt;на всеки N удара&lt;/option&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">          </span>&lt;option value="seconds"&gt;на всеки N секунди&lt;/option&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;/select&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;label for="everyN"&gt;Интервал (N)&lt;/label&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">        </span>&lt;input id="everyN" type="number" min="1" value="8"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;div class="row" style="margin-top:8px"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;button id="btnPrompts" class="primary" style="flex:1"&gt;</span><span class="s3">▶︎</span><span class="s1"> Пусни команди&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;button id="btnNext"&gt;Следваща&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;div class="center" style="margin-top:8px"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;div class="big" id="prompt"&gt;—&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;div class="muted"&gt;Съвет: сложи N=8 удара (2 такта на 4/4) за плавни входове с инерция.&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;/div&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;div class="card"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;div class="row"&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;button id="btnAllStart" class="primary" style="flex:1"&gt;</span><span class="s3">▶︎</span><span class="s1"> Пусни всичко&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>&lt;button id="btnAllStop" style="flex:1"&gt;</span><span class="s3">■</span><span class="s1"> Спри всичко&lt;/button&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>&lt;div class="muted" style="margin-top:8px"&gt;Първият клик отключва звука (правило на браузърите).&lt;/div&gt;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>&lt;/div&gt;</span></p>
<p class="p1"><span class="s1">&lt;/main&gt;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">&lt;script&gt;</span></p>
<p class="p1"><span class="s1">let ac, clickHi, clickLo, runningMetro=false, metroTimer=null, beat=0, beatsPerBar=4, lastTap=0, taps=[];</span></p>
<p class="p1"><span class="s1">let runningIntervals=false, intervalTimer=null, phase='ready', leftInPhase=0, round=0, totalRounds=0;</span></p>
<p class="p1"><span class="s1">let runningPrompts=false, promptsList=[], promptTimer=null, promptEvery=8, promptMode='beats', beatsSince=0;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">const $=id=&gt;document.getElementById(id);</span></p>
<p class="p1"><span class="s1">function fmt(t){ t=Math.max(0,Math.floor(t)); const m=String(Math.floor(t/60)).padStart(2,'0'); const s=String(t%60).padStart(2,'0'); return m+':'+s; }</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">function ensureAudio(){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>if(ac) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>ac = new (window.AudioContext||window.webkitAudioContext)();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>// clicks</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>clickHi = (when)=&gt;{</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const o = ac.createOscillator(); const g = ac.createGain();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>o.type='square'; o.frequency.value=1760; g.gain.value=0.001;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>o.connect(g).connect(ac.destination);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>g.gain.setValueAtTime(0.001, when);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>g.gain.exponentialRampToValueAtTime(0.5, when+0.001);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>g.gain.exponentialRampToValueAtTime(0.001, when+0.06);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>o.start(when); o.stop(when+0.07);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>clickLo = (when)=&gt;{</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const o = ac.createOscillator(); const g = ac.createGain();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>o.type='square'; o.frequency.value=880; g.gain.value=0.001;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>o.connect(g).connect(ac.destination);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>g.gain.setValueAtTime(0.001, when);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>g.gain.exponentialRampToValueAtTime(0.4, when+0.001);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>g.gain.exponentialRampToValueAtTime(0.001, when+0.05);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>o.start(when); o.stop(when+0.06);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>};</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">function startMetronome(){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>ensureAudio(); if(ac.state==='suspended') ac.resume();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>runningMetro=true; beat=0; scheduleTick(); $('btnMetro').textContent='</span><span class="s3">■</span><span class="s1"> Спри метроном';</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">function stopMetronome(){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>runningMetro=false; clearTimeout(metroTimer); $('beat').textContent='—'; $('btnMetro').textContent='</span><span class="s3">▶︎</span><span class="s1"> Пусни метроном';</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">function scheduleTick(){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>if(!runningMetro) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const bpm = Math.max(30, Math.min(220, Number($('bpm').value)||96));</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>$('bpmLive').textContent = bpm+' BPM';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>beatsPerBar = Number($('meter').value)||4;</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const now = ac.currentTime;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const isAccent = (beat % beatsPerBar)===0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>(isAccent?clickHi:clickLo)(now+0.02);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>$('beat').textContent = (beat % beatsPerBar)+1;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>if(runningPrompts &amp;&amp; promptMode==='beats'){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>beatsSince++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if(beatsSince&gt;=promptEvery){ nextPrompt(); beatsSince=0; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>beat++;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const intervalMs = 60000/bpm;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>metroTimer = setTimeout(scheduleTick, intervalMs);</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">$('btnMetro').onclick=()=&gt;{</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>if(!runningMetro) startMetronome(); else stopMetronome();</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">$('btnTap').onclick=()=&gt;{</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const t = performance.now();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>if(t-lastTap&gt;2000) taps.length=0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>if(lastTap) taps.push(t-lastTap);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>lastTap=t;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>if(taps.length&gt;=3){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const avg = taps.slice(-6).reduce((a,b)=&gt;a+b,0)/Math.min(6,taps.length);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const bpm = Math.round(60000/avg);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>$('bpm').value = bpm; $('bpmLive').textContent=bpm+' BPM';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p1"><span class="s1">};</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// Intervals</span></p>
<p class="p1"><span class="s1">function startIntervals(){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>ensureAudio(); if(ac.state==='suspended') ac.resume();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>if(runningIntervals) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const w = Math.max(5, Number($('work').value)||40);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const r = Math.max(5, Number($('rest').value)||20);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>totalRounds = Math.max(1, Number($('rounds').value)||6);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>round = 0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>runningIntervals=true; phase='work'; leftInPhase=w; $('intervalState').textContent='работа'; $('intervalState').className='pill ok'; nextIntervalTick();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>$('btnIntervals').textContent='</span><span class="s3">■</span><span class="s1"> Спри интервали';</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">function stopIntervals(){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>runningIntervals=false; clearTimeout(intervalTimer); $('intervalState').textContent='готов'; $('intervalTime').textContent='00:00'; $('intervalRound').textContent='0/'+totalRounds; $('btnIntervals').textContent='</span><span class="s3">▶︎</span><span class="s1"> Стартирай интервали';</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">function nextIntervalTick(){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>if(!runningIntervals) return;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>$('intervalTime').textContent=fmt(leftInPhase);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>$('intervalRound').textContent=round+'/'+totalRounds;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>if(leftInPhase&lt;=0){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// switch</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if(phase==='work'){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>round++; if(round&gt;totalRounds){ stopIntervals(); return; }</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>phase='rest'; leftInPhase=Math.max(5, Number($('rest').value)||20);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>$('intervalState').textContent='почивка'; $('intervalState').className='pill warn';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>cue('Почивка – дишай.');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}else{</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>phase='work'; leftInPhase=Math.max(5, Number($('work').value)||40);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>$('intervalState').textContent='работа'; $('intervalState').className='pill ok';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">      </span>cue('Работа – влез с инерция!');</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>leftInPhase--;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>intervalTimer=setTimeout(nextIntervalTick,1000);</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// Prompts</span></p>
<p class="p1"><span class="s1">function parsePrompts(){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>promptsList = $('prompts').value.split('\n').map(s=&gt;s.trim()).filter(Boolean);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>if(promptsList.length===0) promptsList=['TopRock','Knee Drop','Sweep Drop'];</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">function nextPrompt(){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>if(promptsList.length===0) parsePrompts();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const i = Math.floor(Math.random()*promptsList.length);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>const p = promptsList[i];</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>$('prompt').textContent = p;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>speak(p);</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">function startPrompts(){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>parsePrompts();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>promptMode = $('mode').value;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>promptEvery = Math.max(1, Number($('everyN').value)||8);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>runningPrompts=true; beatsSince=0;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>$('btnPrompts').textContent='</span><span class="s3">■</span><span class="s1"> Спри команди';</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>if(promptMode==='seconds'){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>promptTimer = setInterval(nextPrompt, promptEvery*1000);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}else{</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>// on beats: will fire from metronome scheduler</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>if(!runningMetro) startMetronome();</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>nextPrompt();</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p1"><span class="s1">function stopPrompts(){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>runningPrompts=false; clearInterval(promptTimer); $('btnPrompts').textContent='</span><span class="s3">▶︎</span><span class="s1"> Пусни команди'; $('prompt').textContent='—';</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">function cue(text){</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>$('status').textContent=text;</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>try{</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">    </span>const u=new SpeechSynthesisUtterance(text); u.lang='bg-BG'; u.rate=1.05; speechSynthesis.cancel(); speechSynthesis.speak(u);</span></p>
<p class="p1"><span class="s1"><span class="Apple-converted-space">  </span>}catch(e){}</span></p>
<p class="p1"><span class="s1">}</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// All-in-one</span></p>
<p class="p1"><span class="s1">$('btnIntervals').onclick=()=&gt; runningIntervals?stopIntervals():startIntervals();</span></p>
<p class="p1"><span class="s1">$('btnPrompts').onclick=()=&gt; runningPrompts?stopPrompts():startPrompts();</span></p>
<p class="p1"><span class="s1">$('btnNext').onclick=()=&gt; nextPrompt();</span></p>
<p class="p1"><span class="s1">$('btnAllStart').onclick=()=&gt;{ if(!runningMetro) startMetronome(); if(!runningIntervals) startIntervals(); if(!runningPrompts) startPrompts(); };</span></p>
<p class="p1"><span class="s1">$('btnAllStop').onclick=()=&gt;{ stopPrompts(); stopIntervals(); stopMetronome(); };</span></p>
<p class="p2"><span class="s1"></span><br></p>
<p class="p1"><span class="s1">// defaults</span></p>
<p class="p1"><span class="s1">$('intervalRound').textContent='0/'+($('rounds').value||6);</span></p>
<p class="p1"><span class="s1">&lt;/script&gt;</span></p>
<p class="p1"><span class="s1">&lt;/body&gt;</span></p>
<p class="p1"><span class="s1">&lt;/html&gt;</span></p>
</body>
</html>
